---
title: "I Like the Stock"
output: html_document
---

```{r}
knitr::opts_chunk$set(echo = FALSE,message = FALSE,warning = FALSE)
  pacman::p_load(bookdown,PlayerRatings,rvest,dplyr,tidyr,RCurl,rPref,readr,DT,bookdown,XML,lubridate,data.table,openxlsx,stringr,quantmod,ggplot2,TTR,rPref,igraph,scales,DBI,RSQLite,XML,RCurl,stringr,httr,openxlsx,progress,glue,caret)

options(scipen=999)
options(warn=-1)

source("money_theme.R")
```

```{r}

# Get Industry & Sector
# https://www.nasdaq.com/market-activity/stocks/screener
sector_industry_file = file.info(list.files(path = "Data",pattern = "nasdaq_screener",full.names = T)) %>% 
  arrange(desc(mtime)) %>% 
  slice(1) %>% 
  row.names(.) %>% 
  read.csv(file = .) %>% 
  dplyr::select(Symbol,Sector,Industry)

# Get all symbols
df_stocks = stockSymbols() %>% 
  dplyr::select(Symbol,Name,Exchange,ETF) %>% 
  filter(Exchange %in% c("NASDAQ","NYSE")) %>% 
  group_by(Symbol) %>% 
  filter(n()==1) %>% 
  ungroup() %>% 
  filter(!grepl("File Creation",Symbol)) %>% 
  filter(!grepl("AXAC-R",Symbol))%>% 
  filter(!grepl("ZCZZT",Symbol)) %>% 
  inner_join(sector_industry_file)


```


```{r}

metrics <- yahooQF(c("Name",
                     "Currency",
                     "Volume",
                     "Market Capitalization",
                     "P/E Ratio",
                     "Price/EPS Estimate Next Year",
                     "Price/Book",
                     "Book Value",
                     "Earnings/Share",
                     "EPS Forward",
                     "Dividend Yield",
                     "Shares Outstanding",
                     "Change From 52-week Low",
                     "Percent Change From 52-week Low",
                     "Change From 52-week High",
                     "Percent Change From 52-week High",
                     "52-week Low",
                     "52-week High"))

df_quotes = getQuote(Symbols = df_stocks$Symbol,what = metrics)
df_quotes$Symbol = row.names(df_quotes)
df_quotes = df_quotes %>% 
  as_tibble() %>% 
  dplyr::mutate(`Market Capitalization`=`Market Capitalization`/1000000000) %>% 
  filter(`Market Capitalization`>0) %>% 
  arrange(desc(`Market Capitalization`)) %>% 
  inner_join(sector_industry_file)

```


```{r}

tickers_filtered = df_quotes %>% 
  group_by(Industry) %>% 
  top_n(n=25,wt=`Market Capitalization`)

  symbols = unique(tickers_filtered$Symbol)
  
  pb <- progress_bar$new(
    format = "  Downloader :what [:bar] :percent eta: :eta",
    total = length(symbols),
    width= 60)
  
  # Stock data
  stock_data =   rbindlist(lapply(symbols,function(symbol) {
    pb$tick()
    stock_symbol <- tryCatch({as.data.frame(getSymbols(symbol, env = NULL))},error=function(e) {e})
    if (class(stock_symbol)[1]=="simpleError") next;
    stock_symbol$Symbol = symbol
    stock_symbol$Date = rownames(stock_symbol)
    stock_symbol$Close = stock_symbol[,4]
    stock_symbol = stock_symbol[,c("Symbol","Date","Close")]
    row.names(stock_symbol) <- NULL
    stock_symbol
  })) %>% 
    dplyr::mutate(Date=ymd(Date))
    
```


# Sectors & Industries

## Sectors

```{r}

df_quotes %>% 
  group_by(Sector) %>% 
  dplyr::summarise(Market_Cap=sum(`Market Capitalization`)) %>% 
  arrange(desc(Market_Cap)) %>% 
  dplyr::mutate(Sector=factor(Sector,levels=rev(.$Sector))) %>% 
  ggplot(.,aes(x=Sector,y=Market_Cap)) +
  geom_col() +
  coord_flip() +
  theme_i_like_the_stock +
  labs(title="Market Cap by Sector",
       caption=timestamp_caption(),
       y="Market Cap (Billions)",
       x="Industry")

```

## Industries

```{r}

df_quotes %>% 
  group_by(Industry) %>% 
  dplyr::summarise(Market_Cap=sum(`Market Capitalization`)) %>% 
  arrange(desc(Market_Cap)) %>% 
  top_n(wt = Market_Cap,n = 40 ) %>% 
  dplyr::mutate(Industry=factor(Industry,levels=rev(.$Industry))) %>% 
  ggplot(.,aes(x=Industry,y=Market_Cap)) +
  # theme(axis.text.y = element_text(size=2)) +
  geom_col() +
  coord_flip() +
  theme_i_like_the_stock +
  labs(title="Market Cap by Industry",
       caption=timestamp_caption(),
       y="Market Cap (Billions)",
       x="Industry")

```

## Biggest Caps by Sector

```{r fig.height=15,fig.width=4}

df_quotes %>% 
  group_by(Sector) %>% 
  top_n(wt = `Market Capitalization`,n = 10) %>% 
  dplyr::mutate(labels=paste0(Sector,Name)) %>% 
  arrange(Sector,desc(`Market Capitalization`)) %>% 
  dplyr::mutate(labels=factor(labels,levels=rev(unique(.$labels)))) %>% 
  ggplot(.,aes(x=labels,y=`Market Capitalization`)) +
  geom_col() +
  coord_flip() +
  facet_wrap(~Sector,ncol=1,scales="free") +
  scale_x_discrete(labels = function(x) gsub("Technology|Consumer Services|Capital Goods|Health Care|Miscellaneous|Consumer Non-Durables|Energy|Finance|Basic Industries|Public Utilities|Transportation||Consumer Durables", "", x)) +
  theme_i_like_the_stock +
  labs(title="Market Cap by Sector",
       caption=timestamp_caption(),
       y="Market Cap (Billions)",
       x=NULL)

```

## Sector Rotations

```{r}

loess_adjust = function(data) {
  # fit_smooth =  smooth.spline(x = data$Date,
  #                 y = data$Growth, 
  #                 all.knots = TRUE, 
  #                 control.spar = list(low = -2, hight = 2))
  # data %>% 
  #   dplyr::mutate(VALUE=fit_smooth$y) %>% 
  #   dplyr::mutate(VALUE=scale(VALUE,center=TRUE,scale=TRUE)) %>%
  #   dplyr::mutate(ema=TTR::EMA(VALUE,9))
  
  grid <- expand.grid(span = seq(0.1, 0.5, len = 2), degree = c(1))
  tr_control = trainControl(method = "repeatedcv",number = 5,repeats = 1)
  fit_gam = suppressWarnings(expr =  { train(y = as.numeric(data$Growth),
        x = data %>% dplyr::select(Date),
        tuneGrid=grid,
        method = "gamLoess") })
  
  data %>%
    dplyr::mutate(Growth=predict(fit_gam,.)) # %>% 
    # dplyr::mutate(Growth=scale(Growth,center=TRUE,scale=TRUE)) %>%
    # dplyr::mutate(ema=TTR::EMA(VALUE,9))
  
}

```


```{r}
df_gamed = stock_data %>% 
  dplyr::mutate(six_months_ago=Date-months(6)) %>% 
  inner_join( stock_data , by=c("six_months_ago"="Date","Symbol"="Symbol") ) %>% 
  dplyr::mutate(Growth=Close.x/Close.y) %>% 
  dplyr::select(Symbol,Date,Growth) %>% 
  inner_join(df_quotes) %>% 
  group_by(Date,Sector) %>% 
  dplyr::summarise(Growth=sum(Growth)/n()) %>% 
  group_by(Date) %>% 
  dplyr::mutate(Growth=Growth/sum(Growth)) %>% 
  dplyr::mutate(Growth=scale(Growth)) %>%
  group_by(Sector) %>% 
  na.omit() %>% 
  do(loess_adjust(data = .)) 

df_rotation_dates = df_gamed %>% 
  dplyr::mutate(Uptrend=ifelse(Growth>0 & lag(Growth)<0,1,0),
                Downtrend=ifelse(Growth<0 & lag(Growth)>0,1,0)) %>% 
  gather(Trend,Value,Uptrend:Downtrend) %>% 
  filter(Value==1)

df_rotation_dates
```

```{r}

df_gamed %>% 
  dplyr::mutate(Uptrend=ifelse(Growth>0 & lag(Growth)<0,1,0),
                Downtrend=ifelse(Growth<0 & lag(Growth)>0,1,0)) %>% 
  gather(Trend,Value,Uptrend:Downtrend) %>% 
  # filter(Trend=="Uptrend") %>% 
  filter(Value==1) %>% 
  filter(Date==max(Date)) %>% 
  dplyr::mutate(Days_Since_Flip=as.numeric(Sys.Date()-Date)) %>% 
  arrange(Trend,desc(Days_Since_Flip))
```

```{r}
df_rotation_dates %>% 
  arrange(Sector,desc(Date)) %>% 
  dplyr::mutate(Days_Since_Last=as.numeric(Date-lead(Date))) %>% 
  dplyr::summarise(n_=n())
```

```{r fig.height=5,fig.width=4 }

df_trend_shifts = 
  df_gamed %>% 
  dplyr::mutate(Uptrend=ifelse(Growth>0 & lag(Growth)<0,1,0),
                Downtrend=ifelse(Growth<0 & lag(Growth)>0,1,0)) %>% 
  gather(Trend,Value,Uptrend:Downtrend) %>% 
  # filter(Trend=="Uptrend") %>% 
  filter(Value==1) %>% 
  filter(Date==max(Date)) %>% 
  ungroup() %>% 
  rename(Shift_Date=Date)

df_gamed %>% 
  # inner_join( stock_data ) %>% 
  left_join( df_trend_shifts %>% dplyr::select(Shift_Date,Sector,Trend,Value) ) %>% 
  filter( Date >= Shift_Date ) %>% 
  dplyr::select(Date,Shift_Date,Sector,Growth,Trend) %>% 
  dplyr::mutate(Days_Since_Shift=as.numeric(Date-Shift_Date)) %>% 
  group_by(Sector) %>% 
  dplyr::mutate(Label=ifelse(Date==last(Date),Sector,NA)) %>% 
  ungroup() %>% 
  ggplot(.,aes(x=Days_Since_Shift,y=Growth,color=Sector)) +
  geom_line(aes(color=Sector)) +
  geom_hline(yintercept = 0,linetype=2) +
  theme_i_like_the_stock +
  theme(legend.position="bottom") +
  facet_wrap(~Trend,ncol=1,scales = "free_y")  +
  geom_text(aes(label=Label),vjust=1)


```

```{r}
df_rotation_dates %>% 
  arrange(Sector,desc(Date)) %>% 
  dplyr::mutate(Days_Since_Last=as.numeric(Date-lead(Date))) %>% 
  dplyr::summarise(sd_=sd(Days_Since_Last,na.rm=T))
```


```{r}
df_gamed %>% 
  # filter(Sector=="Basic Industries") %>% 
  # filter(Industry %in% c("Internet and Information Services","Oil & Gas Production")) %>% 
  ggplot(.,aes(x=Date,y=Growth,fill=Sector,color=Sector)) +
  geom_line() +
  # geom_line(aes(x=Date,y=VALUE)) +
  # geom_smooth() +
  theme_i_like_the_stock +
  theme(legend.position = "bottom") +
  geom_hline(yintercept = 0,linetype=2)
```

```{r}

df_gamed %>% 
  dplyr::mutate(six_months_ago=Date-months(6)) %>% 
  # filter(Sector=="Basic Industries") %>% 
  # filter(Industry %in% c("Internet and Information Services","Oil & Gas Production")) %>% 
  ggplot(.,aes(x=Date,y=Growth,fill=Sector,color=Sector)) +
  geom_line() +
  # geom_line(aes(x=Date,y=VALUE)) +
  # geom_smooth() +
  theme_i_like_the_stock +
  theme(legend.position = "bottom") +
  geom_hline(yintercept = 0,linetype=2)
```


### Elo approach

```{r}

df_elo = stock_data %>% 
  inner_join( df_quotes ) %>% 
  filter(!Sector=="") %>% 
  dplyr::select(Sector,Industry,Symbol,Date,Close) %>% 
  group_by(Symbol) %>% 
  arrange(Symbol,Date) %>% 
  dplyr::mutate(Incr=ifelse(((Close/lag(Close))-1)>0,1,0)) %>% 
  dplyr::mutate(Rolling_Incr=zoo::rollsum(x = Incr,k = 90,NA)) %>% 
  na.omit() %>% 
  dplyr::select(-Close,-Incr) %>% 
  group_by(Sector,Date) %>% 
  dplyr::summarise(Rolling_Incr=mean(Rolling_Incr))

df_skeleton = data.frame(t(combn(unique(df_elo$Sector),2))) %>% 
  tidyr::crossing(Date=unique(df_elo$Date))

df_elo_results = df_skeleton %>% 
  
  inner_join(df_elo,by=c("X1"="Sector","Date"="Date")) %>% 
  na.omit() %>% 
  
  inner_join(df_elo,by=c("X2"="Sector","Date"="Date")) %>% 
  na.omit() %>% 
  dplyr::mutate(Rating=ifelse(Rolling_Incr.x>Rolling_Incr.y,1,
                              ifelse(Rolling_Incr.x<Rolling_Incr.y,0,0.5))) %>% 
  group_by(X1,X2) %>% 
  dplyr::mutate(Date=data.table::frank(x = Date)) %>% 
  dplyr::select(Date,X1,X2,Rating) %>% 
  ungroup()
  
df_elo_calculation = 
  df_elo_results %>% 
  PlayerRatings::elo(.)

  pb <- progress_bar$new(
    format = "  Downloader :what [:bar] :percent eta: :eta",
    total = 365,
    width= 60)
  
  
df_elo_calculation_all_dates = rbindlist(
  lapply(tail(unique(df_elo_results$Date),365),function(date) {
    
    pb$tick()
    PlayerRatings::elo(x = df_elo_results[df_elo_results$Date<=date,]) %>%
    .[["ratings"]] %>% 
    data.frame() %>% 
    dplyr::mutate(Date=date) %>% 
    dplyr::select(Date,Player,Rating)

  })
)

df_elo_calculation_all_dates %>% 
  dplyr::mutate(Rating=rescale(Rating,to=c(0,100))) %>% 
  group_by(Player) %>% 
  dplyr::mutate(Label=ifelse(Date==last(Date),Player,NA)) %>% 
  ungroup() %>% 
  ggplot(.,aes(x=Date,y=Rating,color=Player)) +
  geom_line() +
  theme_i_like_the_stock +
  geom_hline(yintercept = 50,linetype=2)  +
  geom_text(aes(label=Label),vjust=1)


df_elo_calculation_all_dates %>% 
  dplyr::mutate(Rating=rescale(Rating,to=c(0,100))) %>% 
  filter(Date==max(Date)) %>% 
  group_by(Player) %>% 
  dplyr::mutate(Label=paste0(ifelse(Date==last(Date),Player,NA)," (",scales::number(Rating,accuracy = 1),")")) %>% 
  ungroup() %>% 
  ggplot(.,aes(x=Date,y=Rating,color=Player)) +
  geom_line() +
  theme_i_like_the_stock +
  geom_hline(yintercept = 50,linetype=2)  +
  geom_text(aes(label=Label),vjust=1)

```

## Buy and Hold Simulation

```{r}
# Samples

  returns = data.frame()
  time_now = Sys.time()
  while (Sys.time() < time_now + minutes(60)) {
  # while (Sys.time() < time_now + hours(1)) {
    tryCatch(expr = {
    num_stocks = symbols = floor(runif(n = 1,min = 1,max = length(unique(stock_data$Symbol))))
    symbols = unique(stock_data$Symbol) %>% sample(num_stocks)
    
    purchase_date = stock_data %>% filter(Symbol %in% symbols) %>% dplyr::select(Date) %>% sample_n(1) %>% pull(Date)
    max_date = stock_data %>% filter(Date>purchase_date) %>% group_by(Symbol) %>% filter(Date==max(Date)) %>% ungroup() %>% summarise(Date=min(Date)) %>% pull(Date)
    
    duration = sample(seq(as.integer(difftime( max_date , purchase_date , units = "days"))),1)
    if (duration<30) next;
    
    returns = bind_rows(returns,
    stock_data %>% 
      filter(Date %in% c( purchase_date, max_date )) %>% 
      filter(Symbol %in% symbols) %>% 
      group_by(Symbol) %>% 
      dplyr::mutate(shares_purchased_sum=floor((10000/num_stocks))) %>% 
      dplyr::mutate(shares_purchased=floor(shares_purchased_sum/first(Close))) %>% 
      dplyr::mutate(shares_sell=shares_purchased*last(Close)) %>% 
      dplyr::mutate(gains=shares_sell-shares_purchased_sum) %>% 
      dplyr::select(Symbol,gains) %>% 
      distinct() %>% 
      ungroup() %>% 
      dplyr::summarise(gains=sum(gains)/10000) %>% 
      dplyr::mutate(num_stocks=num_stocks,
                    duration=duration) %>% 
      relocate(num_stocks,duration)
    )
    },error=function(e) { message(e)})
  }
```

```{r }
# Visualize
  returns %>% 
    dplyr::mutate(months=ceiling(duration/(365/12))) %>% 
    dplyr::mutate(annualized_return=gains^(1/(duration/365.25))-1) %>% 
    ggplot(.,aes(x=duration,y=annualized_return)) +
    geom_point(size=0.2) +
    geom_smooth() +
    scale_y_continuous(limits=c(-1,2),labels = scales::percent,breaks = seq(-1,2,by=0.25)) +
    scale_x_continuous(breaks=seq(0,15*365,by=365),labels=seq(0,15*365,by=365)/365) +
    geom_hline(yintercept = 0.18,linetype=2,color="red") +
    geom_hline(yintercept = 0,linetype=2,color="lightseagreen") +
    theme_i_like_the_stock
  
```

```{r }
# Visualize
  returns %>% 
    dplyr::mutate(Years=factor(ceiling(duration/(365)))) %>% 
    dplyr::mutate(annualized_return=gains^(1/(duration/365.25))-1) %>% 
    ggplot(.,aes(x=Years,y=annualized_return)) +
    geom_boxplot() +
    scale_y_continuous(limits=c(-1,2),labels = scales::percent,breaks = seq(-1,2,by=0.25)) +
    geom_hline(yintercept = 0.18,linetype=2,color="red") +
    geom_hline(yintercept = 0,color="lightseagreen") +
    theme_i_like_the_stock
  
```


```{r}
# Visualize
  returns %>% 
    dplyr::mutate(months=ceiling(duration/(365/12))) %>% 
    dplyr::mutate(annualized_return=gains^(1/(duration/365.25))-1) %>% 
    ggplot(.,aes(x=duration,y=annualized_return)) +
    geom_point() +
    geom_smooth() +
    scale_y_continuous(limits=c(-3,0),labels = scales::percent,breaks = seq(-3,0,by=0.1)) +
    scale_x_continuous(breaks=seq(0,15*365,by=365),labels=seq(0,15*365,by=365)/365) +
    geom_hline(yintercept = 0.12,linetype=2,color="red") +
    theme_i_like_the_stock
  
```


```{r}
# Visualize
  returns %>% 
    dplyr::mutate(months=ceiling(duration/(365/12))) %>% 
    dplyr::mutate(annualized_return=gains^(1/(duration/365.25))-1) %>% 
    filter(annualized_return<3) %>% 
    ggplot(.,aes(x=num_stocks,y=months)) +
    geom_point(aes(color=annualized_return)) +
    geom_smooth() +
    scale_y_continuous(limits=c(0,3),labels = scales::percent,breaks = seq(0,5,by=0.1)) +
    scale_x_continuous(breaks=seq(0,15*365,by=365),labels=seq(0,15*365,by=365)/365) +
    geom_hline(yintercept = 0.12,linetype=2,color="red") +
    theme_i_like_the_stock
  
```

```{r}
# Visualize
  returns %>% 
    dplyr::mutate(months=ceiling(duration/(365/12))) %>% 
    dplyr::mutate(annualized_return=gains^(1/(duration/365.25))-1) %>% 
    ggplot(.,aes(x=num_stocks,y=annualized_return)) +
    geom_point() +
    geom_smooth() +
    scale_y_continuous(limits=c(-1,1),labels = scales::percent,breaks = seq(-1,1,by=0.1)) +
    scale_x_continuous(breaks=seq(0,15*365,by=365),labels=seq(0,15*365,by=365)/365) +
    theme_i_like_the_stock
  
```

```{r}

returns %>% 
  dplyr::mutate(yrs_held=factor(floor(duration/(365))),
                num_stocks=factor(num_stocks)) %>% 
  dplyr::mutate(annualized_return=gains^(1/(duration/365.25))-1) %>% 
  filter(annualized_return<3) %>% 
  ggplot(.,aes(x=yrs_held,y=num_stocks)) +
  geom_tile(aes(fill=annualized_return)) +
    theme_i_like_the_stock

```

```{r}

lm(annualized_return~num_stocks+duration,data = returns %>% dplyr::mutate(annualized_return=gains^(1/(duration/365.25))-1))

```



