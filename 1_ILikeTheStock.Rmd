---
title: "I Like the Stock"
output: html_document
---

# US Stock Market

```{r}
knitr::opts_chunk$set(echo = FALSE,message = FALSE,warning = FALSE)
  pacman::p_load(bookdown,PlayerRatings,rvest,dplyr,tidyr,RCurl,rPref,readr,DT,bookdown,XML,lubridate,data.table,openxlsx,stringr,beepr,quantmod,ggplot2,TTR,rPref,igraph,scales,DBI,RSQLite,XML,RCurl,stringr,httr,openxlsx,progress,glue)

  options(scipen=999)
  options(warn=-1)
  options(error = beep)
```

```{r}

# Get Industry & Sector
# https://www.nasdaq.com/market-activity/stocks/screener
sector_industry_file = file.info(list.files(path = "Data",pattern = "nasdaq_screener",full.names = T)) %>% 
  arrange(desc(mtime)) %>% 
  slice(1) %>% 
  row.names(.) %>% 
  read.csv(file = .) %>% 
  dplyr::select(Symbol,Sector,Industry)

# Get all symbols
df_stocks = stockSymbols() %>% 
  dplyr::select(Symbol,Name,Exchange,ETF) %>% 
  filter(Exchange %in% c("NASDAQ","NYSE")) %>% 
  group_by(Symbol) %>% 
  filter(n()==1) %>% 
  ungroup() %>% 
  filter(!grepl("File Creation",Symbol)) %>% 
  filter(!grepl("AXAC-R",Symbol))%>% 
  filter(!grepl("ZCZZT",Symbol)) %>% 
  inner_join(sector_industry_file)


```


```{r}

metrics <- yahooQF(c("Name",
                     "Currency",
                     "Volume",
                     "Market Capitalization",
                     "P/E Ratio",
                     "Price/EPS Estimate Next Year",
                     "Price/Book",
                     "Book Value",
                     "Earnings/Share",
                     "EPS Forward",
                     "Dividend Yield",
                     "Shares Outstanding",
                     "Change From 52-week Low",
                     "Percent Change From 52-week Low",
                     "Change From 52-week High",
                     "Percent Change From 52-week High",
                     "52-week Low",
                     "52-week High"))

df_quotes = getQuote(Symbols = df_stocks$Symbol,what = metrics)
df_quotes$Symbol = row.names(df_quotes)
df_quotes = df_quotes %>% 
  as_tibble() %>% 
  dplyr::mutate(`Market Capitalization`=`Market Capitalization`/1000000000) %>% 
  filter(`Market Capitalization`>0) %>% 
  arrange(desc(`Market Capitalization`)) %>% 
  inner_join(sector_industry_file)

```


```{r}

tickers_filtered = df_quotes %>% 
  top_n(n=10,wt=`Market Capitalization`)

  symbols = unique(tickers_filtered$Symbol)
  
  pb <- progress_bar$new(
    format = "  Downloader :what [:bar] :percent eta: :eta",
    total = length(symbols),
    width= 60)
  
  # Stock data
  stock_data =   rbindlist(lapply(symbols,function(symbol) {
    stock_symbol <- tryCatch({as.data.frame(getSymbols(symbol, env = NULL))},error=function(e) {e})
    if (class(stock_symbol)[1]=="simpleError") next;
    stock_symbol$Symbol = symbol
    stock_symbol$Date = rownames(stock_symbol)
    stock_symbol$Close = stock_symbol[,4]
    stock_symbol = stock_symbol[,c("Symbol","Date","Close")]
    row.names(stock_symbol) <- NULL
    stock_symbol
  }))
    
```


```{r}
# Samples

  returns = data.frame()
  i = 0
  while (i < 500) {
    tryCatch(expr = {
    num_stocks = symbols = floor(runif(n = 1,min = 1,max = length(unique(stock_data$Symbol))))
    symbols = unique(stock_data$Symbol) %>% sample(num_stocks)
    
    purchase_date = stock_data %>% filter(Symbol %in% symbols) %>% dplyr::select(Date) %>% sample_n(1) %>% pull(Date)
    max_date = stock_data %>% filter(Date>purchase_date) %>% group_by(Symbol) %>% filter(Date==max(Date)) %>% ungroup() %>% summarise(Date=min(Date)) %>% pull(Date)
    
    duration = sample(seq(as.integer(difftime( max_date , purchase_date , units = "days"))),1)
    if (duration<30) next;
    
    returns = bind_rows(returns,
    stock_data %>% 
      filter(Date %in% c( purchase_date, max_date )) %>% 
      filter(Symbol %in% symbols) %>% 
      group_by(Symbol) %>% 
      dplyr::mutate(shares_purchased_sum=floor((10000/num_stocks))) %>% 
      dplyr::mutate(shares_purchased=floor(shares_purchased_sum/first(Close))) %>% 
      dplyr::mutate(shares_sell=shares_purchased*last(Close)) %>% 
      dplyr::mutate(gains=shares_sell-shares_purchased_sum) %>% 
      dplyr::select(Symbol,gains) %>% 
      distinct() %>% 
      ungroup() %>% 
      dplyr::summarise(gains=sum(gains)/10000) %>% 
      dplyr::mutate(num_stocks=num_stocks,
                    duration=duration) %>% 
      relocate(num_stocks,duration)
    )
    },error=function(e) { message(e)})
 i = i + 1
  }
```

```{r }
# Visualize
  returns %>% 
    dplyr::mutate(months=ceiling(duration/(365/12))) %>% 
    dplyr::mutate(annualized_return=gains^(1/(duration/365.25))-1) %>% 
    ggplot(.,aes(x=duration,y=annualized_return)) +
    geom_point(size=0.2) +
    geom_smooth() +
    scale_y_continuous(limits=c(-1,2),labels = scales::percent,breaks = seq(-1,2,by=0.25)) +
    scale_x_continuous(breaks=seq(0,15*365,by=365),labels=seq(0,15*365,by=365)/365) +
    geom_hline(yintercept = 0.18,linetype=2,color="red") +
    geom_hline(yintercept = 0,linetype=2,color="lightseagreen",size=2)
  
```

```{r }
# Visualize
  returns %>% 
    dplyr::mutate(Years=factor(ceiling(duration/(365)))) %>% 
    dplyr::mutate(annualized_return=gains^(1/(duration/365.25))-1) %>% 
    ggplot(.,aes(x=Years,y=annualized_return)) +
    geom_boxplot() +
    scale_y_continuous(limits=c(-1,2),labels = scales::percent,breaks = seq(-1,2,by=0.25)) +
    geom_hline(yintercept = 0.18,linetype=2,color="red") +
    geom_hline(yintercept = 0,color="lightseagreen",size=2)
  
```


```{r}
# Visualize
  returns %>% 
    dplyr::mutate(months=ceiling(duration/(365/12))) %>% 
    dplyr::mutate(annualized_return=gains^(1/(duration/365.25))-1) %>% 
    ggplot(.,aes(x=duration,y=annualized_return)) +
    geom_point() +
    geom_smooth() +
    scale_y_continuous(limits=c(-3,0),labels = scales::percent,breaks = seq(-3,0,by=0.1)) +
    scale_x_continuous(breaks=seq(0,15*365,by=365),labels=seq(0,15*365,by=365)/365) +
    geom_hline(yintercept = 0.12,linetype=2,color="red")
  
```


```{r}
# Visualize
  returns %>% 
    dplyr::mutate(months=ceiling(duration/(365/12))) %>% 
    dplyr::mutate(annualized_return=gains^(1/(duration/365.25))-1) %>% 
    filter(annualized_return<3) %>% 
    ggplot(.,aes(x=num_stocks,y=months)) +
    geom_point(aes(color=annualized_return)) +
    geom_smooth() +
    scale_y_continuous(limits=c(0,3),labels = scales::percent,breaks = seq(0,5,by=0.1)) +
    scale_x_continuous(breaks=seq(0,15*365,by=365),labels=seq(0,15*365,by=365)/365) +
    geom_hline(yintercept = 0.12,linetype=2,color="red")
  
```

```{r}
# Visualize
  returns %>% 
    dplyr::mutate(months=ceiling(duration/(365/12))) %>% 
    dplyr::mutate(annualized_return=gains^(1/(duration/365.25))-1) %>% 
    ggplot(.,aes(x=num_stocks,y=annualized_return)) +
    geom_point() +
    geom_smooth() +
    scale_y_continuous(limits=c(-1,1),labels = scales::percent,breaks = seq(-1,1,by=0.1)) +
    scale_x_continuous(breaks=seq(0,15*365,by=365),labels=seq(0,15*365,by=365)/365)
  
```

```{r}

returns %>% 
  dplyr::mutate(yrs_held=factor(floor(duration/(365))),
                num_stocks=factor(num_stocks)) %>% 
  dplyr::mutate(annualized_return=gains^(1/(duration/365.25))-1) %>% 
  filter(annualized_return<3) %>% 
  ggplot(.,aes(x=yrs_held,y=num_stocks)) +
  geom_tile(aes(fill=annualized_return))

```

```{r}

lm(annualized_return~num_stocks+duration,data = returns %>% dplyr::mutate(annualized_return=gains^(1/(duration/365.25))-1))
```



