---
title: "I Like the Stock"
output: html_document
---

```{r}
knitr::opts_chunk$set(echo = FALSE,message = FALSE,warning = FALSE,dev = "svg")
install.packages('quantmod',repos = "http://cran.us.r-project.org")
  pacman::p_load(bookdown,PlayerRatings,rvest,dplyr,tidyr,RCurl,rPref,readr,DT,bookdown,XML,lubridate,data.table,openxlsx,stringr,quantmod,ggplot2,TTR,rPref,igraph,scales,DBI,RSQLite,XML,RCurl,stringr,httr,openxlsx,progress,glue,caret,tidyquant)

options(scipen=999)
options(warn=-1)

source("money_theme.R")
```

```{r}

query_yahoo = function(ticker) {
  getSymbols(ticker, env = NULL) %>% 
  as.data.frame(.) %>% 
  dplyr::mutate(Date=ymd(row.names(.))) %>% 
  dplyr::select(c(7,4)) %>% 
  setNames(.,c("Date","Value")) %>% 
  na.omit() %>% 
  dplyr::mutate(SMA_180=TTR::SMA(x = Value,n = 365.25*0.5)) %>% 
  dplyr::mutate(SMA_365=TTR::SMA(x = Value,n = 365.25*1)) %>% 
  dplyr::mutate(SMA_730=TTR::SMA(x = Value,n = 365.25*2))
}
```

```{r}
fit_draw_abline = function(date1,date2,value1,value2) {
  
  data.frame(Date=c(date1,date2),
             GSPC.Close=c(value1,value2)) %>% 
    lm(data = .,formula = GSPC.Close~Date) %>% 
    coef(.) %>% 
    as.numeric(.) %>% 
    geom_abline(intercept = .[1],slope = .[2])
  
}
```

```{r}
draw_support_resistance = function(values) {
  geom_hline(yintercept = values,color="lightseagreen")
}
```

```{r}
fit_draw_fibonacci = function(low,high) {
  fibonaccis = round(low+(high-low)*c(0.236,0.382,0.50,0.618,0.786),digits = 1)
  list(geom_hline(yintercept = fibonaccis,linetype=2,color="gray60" ),
       annotate(geom="text",x=Sys.Date(),y=fibonaccis,label=fibonaccis,size=2))
}
```

```{r}
draw_sma = function(values,data) {
  print(data)
  
}
```

```{r}

# Get Industry & Sector
# https://www.nasdaq.com/market-activity/stocks/screener
sector_industry_file = file.info(list.files(path = "Data",pattern = "nasdaq_screener",full.names = T)) %>% 
  arrange(desc(mtime)) %>% 
  slice(1) %>% 
  row.names(.) %>% 
  read.csv(file = .) %>% 
  dplyr::select(Symbol,Sector,Industry)

# Get all symbols
df_stocks = stockSymbols() %>% 
  dplyr::select(Symbol,Name,Exchange,ETF) %>% 
  filter(Exchange %in% c("NASDAQ","NYSE")) %>% 
  group_by(Symbol) %>% 
  filter(n()==1) %>% 
  ungroup() %>% 
  filter(!grepl("File Creation",Symbol)) %>% 
  filter(!grepl("AXAC-R",Symbol))%>% 
  filter(!grepl("ZCZZT",Symbol)) %>% 
  inner_join(sector_industry_file)


```

# Index

## SP500

```{r sp500_1, fig.height=20,fig.width=20}

query_yahoo(ticker = "^GSPC") %>% 
  ggplot(.,aes(x=Date,y=Value)) +
  geom_line() +
  fit_draw_abline(date1 = ymd("2022-01-01"),date2 = ymd("2020-01-01"),value1 = 4850,value2 = 3300) +
  fit_draw_abline(date1 = ymd("2022-05-01"),date2 = ymd("2020-02-01"),value1 = 3901.36,value2 = 2120) +
  fit_draw_abline(date1 = ymd("2022-01-21"),date2 = ymd("2022-02-23"),value1 = 4300,value2 = 4200) +
  fit_draw_fibonacci(low = 0,high = 4705) +
  draw_support_resistance(values = c(4800,3400,2900,2250,2150)) +
  geom_line(aes(x=Date,y=SMA_180),linetype=2,color="green",size=1.5) +
  geom_line(aes(x=Date,y=SMA_365),linetype=2,color="yellow",size=1.5) +
  geom_line(aes(x=Date,y=SMA_730),linetype=2,color="red",size=1.5) +
  scale_x_date(date_breaks = "1 year",date_labels = "%Y") +
  scale_y_continuous(breaks=seq(0,5000,by=100)) +
  geom_vline(xintercept = Sys.Date(),linetype=2,color="gray50") +
  theme_i_like_the_stock(base_size = 20)

```


```{r sp500_2, fig.height=20,fig.width=20}

query_yahoo(ticker = "^GSPC") %>% 
  filter(Date>=Sys.Date()-days(30)) %>% 
  ggplot(.,aes(x=Date,y=Value)) +
  geom_line() +
  fit_draw_abline(date1 = ymd("2022-01-01"),date2 = ymd("2020-01-01"),value1 = 4850,value2 = 3300) +
  fit_draw_abline(date1 = ymd("2022-05-01"),date2 = ymd("2020-02-01"),value1 = 3901.36,value2 = 2120) +
  fit_draw_abline(date1 = ymd("2022-01-21"),date2 = ymd("2022-02-23"),value1 = 4300,value2 = 4200) +
  fit_draw_fibonacci(low = 0,high = 4705) +
  draw_support_resistance(values = c(4800,3400,2900,2250,2150)) +
  geom_line(aes(x=Date,y=SMA_180),linetype=2,color="green",size=1.5) +
  geom_line(aes(x=Date,y=SMA_365),linetype=2,color="yellow",size=1.5) +
  geom_line(aes(x=Date,y=SMA_730),linetype=2,color="red",size=1.5) +
  scale_x_date(date_breaks = "1 year",date_labels = "%Y") +
  scale_y_continuous(breaks=seq(0,5000,by=100)) +
  geom_vline(xintercept = Sys.Date(),linetype=2,color="gray50") +
  theme_i_like_the_stock(base_size = 20)

```

## C25

```{r c25_1, fig.height=20,fig.width=20}

query_yahoo(ticker = "^OMXC25") %>% 
  ggplot(.,aes(x=Date,y=Value)) +
  geom_line() +
  scale_x_date(date_breaks = "1 year",date_labels = "%Y") +
  scale_y_continuous(breaks=seq(0,5000,by=100),limits = c(900,NA)) +
  fit_draw_abline(date1 = ymd("2020-02-01"),date2 = ymd("2021-08-01"),value1 = 1360,value2 = 2000) +
  fit_draw_abline(date1 = ymd("2020-03-15"),date2 = ymd("2021-11-01"),value1 = 1000,value2 = 1800) +
  fit_draw_abline(date1 = ymd("2021-09-21"),date2 = ymd("2022-02-23"),value1 = 1840,value2 = 1650) +
  fit_draw_fibonacci(low = 0,high = 2020) +
  draw_support_resistance(values = c(2000,1800,1580,1450,1150)) +
  geom_line(aes(x=Date,y=SMA_180),linetype=2,color="green",size=1.5) +
  geom_line(aes(x=Date,y=SMA_365),linetype=2,color="yellow",size=1.5) +
  geom_line(aes(x=Date,y=SMA_730),linetype=2,color="red",size=1.5) +
  geom_vline(xintercept = Sys.Date(),linetype=2,color="gray50")  +
  theme_i_like_the_stock(base_size = 20)

```


```{r c25_2, fig.height=20,fig.width=20}

query_yahoo(ticker = "^OMXC25") %>% 
  filter(Date>=Sys.Date()-days(30)) %>% 
  ggplot(.,aes(x=Date,y=Value)) +
  geom_line() +
  scale_x_date(date_breaks = "1 year",date_labels = "%Y") +
  scale_y_continuous(breaks=seq(0,5000,by=100),limits = c(900,NA)) +
  fit_draw_abline(date1 = ymd("2020-02-01"),date2 = ymd("2021-08-01"),value1 = 1360,value2 = 2000) +
  fit_draw_abline(date1 = ymd("2020-03-15"),date2 = ymd("2021-11-01"),value1 = 1000,value2 = 1800) +
  fit_draw_abline(date1 = ymd("2021-09-21"),date2 = ymd("2022-02-23"),value1 = 1840,value2 = 1650) +
  fit_draw_fibonacci(low = 0,high = 2020) +
  draw_support_resistance(values = c(2000,1800,1580,1450,1150)) +
  geom_line(aes(x=Date,y=SMA_180),linetype=2,color="green",size=1.5) +
  geom_line(aes(x=Date,y=SMA_365),linetype=2,color="yellow",size=1.5) +
  geom_line(aes(x=Date,y=SMA_730),linetype=2,color="red",size=1.5) +
  geom_vline(xintercept = Sys.Date(),linetype=2,color="gray50")  +
  theme_i_like_the_stock(base_size = 20)

```

# Crypto

## BTC

```{r btc_1, fig.height=20,fig.width=20}

query_yahoo(ticker = "BTC-USD") %>% 
  ggplot(.,aes(x=Date,y=Value)) +
  geom_line() +
  fit_draw_fibonacci(low = 0,high = 67566.83) +
  draw_support_resistance(values = c(30000,20000)) +
  scale_x_date(date_breaks = "1 year",date_labels = "%Y") +
  scale_y_continuous(breaks=seq(0,70000,by=5000)) +
  geom_vline(xintercept = Sys.Date(),linetype=2,color="gray50")  +
  theme_i_like_the_stock(base_size = 20)


```


```{r btc_2, fig.height=20,fig.width=20}

query_yahoo(ticker = "BTC-USD") %>% 
  filter(Date>=Sys.Date()-days(30)) %>% 
  ggplot(.,aes(x=Date,y=Value)) +
  geom_line() +
  fit_draw_fibonacci(low = 0,high = 67566.83) +
  draw_support_resistance(values = c(30000,20000)) +
  scale_x_date(date_breaks = "1 year",date_labels = "%Y") +
  scale_y_continuous(breaks=seq(0,70000,by=5000)) +
  geom_vline(xintercept = Sys.Date(),linetype=2,color="gray50")  +
  theme_i_like_the_stock(base_size = 20)


```

# Stocks

```{r}

metrics <- yahooQF(c("Name",
                     "Currency",
                     "Volume",
                     "Market Capitalization",
                     "P/E Ratio",
                     "Price/EPS Estimate Next Year",
                     "Price/Book",
                     "Book Value",
                     "Earnings/Share",
                     "EPS Forward",
                     "Dividend Yield",
                     "Shares Outstanding",
                     "Change From 52-week Low",
                     "Percent Change From 52-week Low",
                     "Change From 52-week High",
                     "Percent Change From 52-week High",
                     "52-week Low",
                     "52-week High"))

df_quotes = getQuote(Symbols = df_stocks$Symbol,what = metrics)
df_quotes$Symbol = row.names(df_quotes)
df_quotes = df_quotes %>% 
  as_tibble() %>% 
  dplyr::mutate(`Market Capitalization`=`Market Capitalization`/1000000000) %>% 
  filter(`Market Capitalization`>0) %>% 
  arrange(desc(`Market Capitalization`)) %>% 
  inner_join(sector_industry_file)

```


```{r}

tickers_filtered = df_quotes %>% 
  group_by(Sector) %>%
  top_n(n=5,wt=`Market Capitalization`) %>% 
  ungroup()

  symbols = unique(tickers_filtered$Symbol)
  
  pb <- progress_bar$new(
    format = "  Downloader :what [:bar] :percent eta: :eta",
    total = length(symbols),
    width= 60)
  
  # Stock data
  stock_data =   rbindlist(lapply(symbols,function(symbol) {
    pb$tick()
    stock_symbol <- tryCatch({
          temp_df = as.data.frame(getSymbols(symbol, env = NULL))
          temp_df$Symbol = symbol
          temp_df$Date = rownames(temp_df)
          temp_df$Close = temp_df[,4]
          temp_df = temp_df[,c("Symbol","Date","Close")]
          row.names(temp_df) <- NULL
          temp_df
  
      },error=function(e) { data.frame() })

  })) %>% 
    dplyr::mutate(Date=ymd(Date))
    
```


# Sectors & Industries

## Sectors

```{r}

df_quotes %>% 
  group_by(Sector) %>% 
  dplyr::summarise(Market_Cap=sum(`Market Capitalization`)) %>% 
  arrange(desc(Market_Cap)) %>% 
  dplyr::mutate(Sector=factor(Sector,levels=rev(.$Sector))) %>% 
  ggplot(.,aes(x=Sector,y=Market_Cap)) +
  geom_col() +
  coord_flip() +
  theme_i_like_the_stock(base_size = 12) +
  labs(title="Market Cap by Sector",
       caption=timestamp_caption(),
       y="Market Cap (Billions)",
       x="Industry")

```

## Industries

```{r}

df_quotes %>% 
  group_by(Industry) %>% 
  dplyr::summarise(Market_Cap=sum(`Market Capitalization`)) %>% 
  arrange(desc(Market_Cap)) %>% 
  top_n(wt = Market_Cap,n = 40 ) %>% 
  dplyr::mutate(Industry=factor(Industry,levels=rev(.$Industry))) %>% 
  ggplot(.,aes(x=Industry,y=Market_Cap)) +
  # theme(axis.text.y = element_text(size=2)) +
  geom_col() +
  coord_flip() +
  theme_i_like_the_stock(base_size = 12) +
  labs(title="Market Cap by Industry",
       caption=timestamp_caption(),
       y="Market Cap (Billions)",
       x="Industry")

```

## Biggest Caps by Sector

```{r fig.height=60,fig.width=20}

df_quotes %>% 
  group_by(Sector) %>% 
  top_n(wt = `Market Capitalization`,n = 10) %>% 
  dplyr::mutate(labels=paste0(Sector,Name)) %>% 
  arrange(Sector,desc(`Market Capitalization`)) %>% 
  dplyr::mutate(labels=factor(labels,levels=rev(unique(.$labels)))) %>% 
  ggplot(.,aes(x=labels,y=`Market Capitalization`)) +
  geom_col() +
  coord_flip() +
  facet_wrap(~Sector,ncol=1,scales="free") +
  scale_x_discrete(labels = function(x) gsub("Technology|Consumer Services|Capital Goods|Health Care|Miscellaneous|Consumer Non-Durables|Energy|Finance|Basic Industries|Public Utilities|Transportation||Consumer Durables", "", x)) +
  theme_i_like_the_stock(base_size = 12) +
  labs(title="Market Cap by Sector",
       caption=timestamp_caption(),
       y="Market Cap (Billions)",
       x=NULL)

```

## Sector Rotations

```{r}

loess_adjust = function(data) {
  # fit_smooth =  smooth.spline(x = data$Date,
  #                 y = data$Growth, 
  #                 all.knots = TRUE, 
  #                 control.spar = list(low = -2, hight = 2))
  # data %>% 
  #   dplyr::mutate(VALUE=fit_smooth$y) %>% 
  #   dplyr::mutate(VALUE=scale(VALUE,center=TRUE,scale=TRUE)) %>%
  #   dplyr::mutate(ema=TTR::EMA(VALUE,9))
  
  grid <- expand.grid(span = seq(0.1, 0.5, len = 2), degree = c(1))
  tr_control = trainControl(method = "repeatedcv",number = 5,repeats = 1)
  fit_gam = suppressWarnings(expr =  { train(y = as.numeric(data$Growth),
        x = data %>% dplyr::select(Date),
        tuneGrid=grid,
        method = "gamLoess") })
  
  data %>%
    dplyr::mutate(Growth=predict(fit_gam,.)) # %>% 
    # dplyr::mutate(Growth=scale(Growth,center=TRUE,scale=TRUE)) %>%
    # dplyr::mutate(ema=TTR::EMA(VALUE,9))
  
}

```


```{r}
df_gamed = stock_data %>% 
  dplyr::mutate(six_months_ago=Date-months(6)) %>% 
  inner_join( stock_data , by=c("six_months_ago"="Date","Symbol"="Symbol") ) %>% 
  dplyr::mutate(Growth=Close.x/Close.y) %>% 
  dplyr::select(Symbol,Date,Growth) %>% 
  inner_join(df_quotes) %>% 
  group_by(Date,Sector) %>% 
  dplyr::summarise(Growth=sum(Growth)/n()) %>% 
  group_by(Date) %>% 
  dplyr::mutate(Growth=Growth/sum(Growth)) %>% 
  dplyr::mutate(Growth=scale(Growth)) %>%
  group_by(Sector) %>% 
  na.omit() %>% 
  do(loess_adjust(data = .)) 

df_rotation_dates = df_gamed %>% 
  dplyr::mutate(Uptrend=ifelse(Growth>0 & lag(Growth)<0,1,0),
                Downtrend=ifelse(Growth<0 & lag(Growth)>0,1,0)) %>% 
  gather(Trend,Value,Uptrend:Downtrend) %>% 
  filter(Value==1)

df_rotation_dates
```

```{r}

df_gamed %>% 
  dplyr::mutate(Uptrend=ifelse(Growth>0 & lag(Growth)<0,1,0),
                Downtrend=ifelse(Growth<0 & lag(Growth)>0,1,0)) %>% 
  gather(Trend,Value,Uptrend:Downtrend) %>% 
  # filter(Trend=="Uptrend") %>% 
  filter(Value==1) %>% 
  filter(Date==max(Date)) %>% 
  dplyr::mutate(Days_Since_Flip=as.numeric(Sys.Date()-Date)) %>% 
  arrange(Trend,desc(Days_Since_Flip))
```

```{r}
df_rotation_dates %>% 
  arrange(Sector,desc(Date)) %>% 
  dplyr::mutate(Days_Since_Last=as.numeric(Date-lead(Date))) %>% 
  dplyr::summarise(n_=n())
```

```{r fig.height=5,fig.width=4 }

df_trend_shifts = 
  df_gamed %>% 
  dplyr::mutate(Uptrend=ifelse(Growth>0 & lag(Growth)<0,1,0),
                Downtrend=ifelse(Growth<0 & lag(Growth)>0,1,0)) %>% 
  gather(Trend,Value,Uptrend:Downtrend) %>% 
  # filter(Trend=="Uptrend") %>% 
  filter(Value==1) %>% 
  filter(Date==max(Date)) %>% 
  ungroup() %>% 
  rename(Shift_Date=Date)

df_gamed %>% 
  # inner_join( stock_data ) %>% 
  left_join( df_trend_shifts %>% dplyr::select(Shift_Date,Sector,Trend,Value) ) %>% 
  filter( Date >= Shift_Date ) %>% 
  dplyr::select(Date,Shift_Date,Sector,Growth,Trend) %>% 
  dplyr::mutate(Days_Since_Shift=as.numeric(Date-Shift_Date)) %>% 
  group_by(Sector) %>% 
  dplyr::mutate(Label=ifelse(Date==last(Date),Sector,NA)) %>% 
  ungroup() %>% 
  ggplot(.,aes(x=Days_Since_Shift,y=Growth,color=Sector)) +
  geom_line(aes(color=Sector)) +
  geom_hline(yintercept = 0,linetype=2) +
  theme_i_like_the_stock(base_size = 12) +
  theme(legend.position="bottom") +
  facet_wrap(~Trend,ncol=1,scales = "free_y")  +
  geom_text(aes(label=Label),vjust=1)


```

```{r}
df_rotation_dates %>% 
  arrange(Sector,desc(Date)) %>% 
  dplyr::mutate(Days_Since_Last=as.numeric(Date-lead(Date))) %>% 
  dplyr::summarise(sd_=sd(Days_Since_Last,na.rm=T))
```


```{r}
df_gamed %>% 
  # filter(Sector=="Basic Industries") %>% 
  # filter(Industry %in% c("Internet and Information Services","Oil & Gas Production")) %>% 
  ggplot(.,aes(x=Date,y=Growth,fill=Sector,color=Sector)) +
  geom_line() +
  # geom_line(aes(x=Date,y=VALUE)) +
  # geom_smooth() +
  theme_i_like_the_stock(base_size = 12) +
  theme(legend.position = "bottom") +
  geom_hline(yintercept = 0,linetype=2)
```

```{r}

df_gamed %>% 
  dplyr::mutate(six_months_ago=Date-months(6)) %>% 
  # filter(Sector=="Basic Industries") %>% 
  # filter(Industry %in% c("Internet and Information Services","Oil & Gas Production")) %>% 
  ggplot(.,aes(x=Date,y=Growth,fill=Sector,color=Sector)) +
  geom_line() +
  # geom_line(aes(x=Date,y=VALUE)) +
  # geom_smooth() +
  theme_i_like_the_stock(base_size = 12) +
  theme(legend.position = "bottom") +
  geom_hline(yintercept = 0,linetype=2)
```


### Elo approach

```{r}

df_elo = stock_data %>% 
  inner_join( df_quotes ) %>% 
  filter(!Sector=="") %>% 
  dplyr::select(Sector,Industry,Symbol,Date,Close) %>% 
  group_by(Symbol) %>% 
  arrange(Symbol,Date) %>% 
  dplyr::mutate(Incr=ifelse(((Close/lag(Close))-1)>0,1,0)) %>% 
  dplyr::mutate(Rolling_Incr=zoo::rollsum(x = Incr,k = 90,NA)) %>% 
  na.omit() %>% 
  dplyr::select(-Close,-Incr) %>% 
  group_by(Sector,Date) %>% 
  dplyr::summarise(Rolling_Incr=mean(Rolling_Incr))

df_skeleton = data.frame(t(combn(unique(df_elo$Sector),2))) %>% 
  tidyr::crossing(Date=unique(df_elo$Date))

df_elo_results = df_skeleton %>% 
  
  inner_join(df_elo,by=c("X1"="Sector","Date"="Date")) %>% 
  na.omit() %>% 
  
  inner_join(df_elo,by=c("X2"="Sector","Date"="Date")) %>% 
  na.omit() %>% 
  dplyr::mutate(Rating=ifelse(Rolling_Incr.x>Rolling_Incr.y,1,
                              ifelse(Rolling_Incr.x<Rolling_Incr.y,0,0.5))) %>% 
  group_by(X1,X2) %>% 
  dplyr::mutate(Date=data.table::frank(x = Date)) %>% 
  dplyr::select(Date,X1,X2,Rating) %>% 
  ungroup()
  
df_elo_calculation = 
  df_elo_results %>% 
  PlayerRatings::elo(.)

  pb <- progress_bar$new(
    format = "  Downloader :what [:bar] :percent eta: :eta",
    total = 365,
    width= 60)
  
  
df_elo_calculation_all_dates = rbindlist(
  lapply(tail(unique(df_elo_results$Date),365),function(date) {
    
    pb$tick()
    PlayerRatings::elo(x = df_elo_results[df_elo_results$Date<=date,]) %>%
    .[["ratings"]] %>% 
    data.frame() %>% 
    dplyr::mutate(Date=date) %>% 
    dplyr::select(Date,Player,Rating)

  })
)

df_elo_calculation_all_dates %>% 
  dplyr::mutate(Rating=rescale(Rating,to=c(0,100))) %>% 
  group_by(Player) %>% 
  dplyr::mutate(Label=ifelse(Date==last(Date),Player,NA)) %>% 
  ungroup() %>% 
  ggplot(.,aes(x=Date,y=Rating,color=Player)) +
  geom_line() +
  theme_i_like_the_stock(base_size = 12) +
  geom_hline(yintercept = 50,linetype=2)  +
  geom_text(aes(label=Label),vjust=1)


df_elo_calculation_all_dates %>% 
  dplyr::mutate(Rating=rescale(Rating,to=c(0,100))) %>% 
  filter(Date==max(Date)) %>% 
  group_by(Player) %>% 
  dplyr::mutate(Label=paste0(ifelse(Date==last(Date),Player,NA)," (",scales::number(Rating,accuracy = 1),")")) %>% 
  ungroup() %>% 
  ggplot(.,aes(x=Date,y=Rating,color=Player)) +
  geom_line() +
  theme_i_like_the_stock(base_size = 12) +
  geom_hline(yintercept = 50,linetype=2)  +
  geom_text(aes(label=Label),vjust=1)

```

# ETF

## Nordnet ETF'er

```{r eval=F}
df_nordnet_etf = rbindlist(lapply(seq(15),function(x) {
  
    source_url = paste0("https://www.nordnet.dk/markedet/etf-lister?sortField=yield_1y&sortOrder=descending&page=",x)
    nordnet_etf =
      xml2::read_html(source_url) %>%
      html_node("#main-content > div > div.PageWrapper__Outer-sc-1ur2ylx-0.kpJmDN > div > div > div > div.Box__StyledDiv-sc-1bfv3i9-0.gBipNb > div") %>%
        html_children() %>% 
        lapply(.,function(x) {
          
          x %>% html_children()  %>% html_text() %>% unlist() %>% t %>% as.data.frame()
          # data.frame(
          #   name=  x %>% html_children() %>% html_children() %>% rvest::html_attr("value")
          # )
        }) %>% 
        rbindlist(.) %>% 
      tail(-1) %>% 
      setNames(.,c("buy","name","type","gain_today","gain_1yr","aaop","morningstar","V1","sustain","belaaning","owners","V2")) %>% 
      dplyr::mutate(gain_today=as.numeric(gsub("%","",gsub("\\,","\\.",gain_today)))/100) %>% 
      dplyr::mutate(gain_1yr=as.numeric(gsub("%","",gsub("\\,","\\.",gain_1yr)))/100) %>% 
      dplyr::mutate(aaop=as.numeric(gsub("%","",gsub("\\,","\\.",aaop)))/100) %>% 
      dplyr::mutate(morningstar=gsub(" stars","",morningstar)) %>% 
      dplyr::mutate(belaaning=as.numeric(gsub("%","",belaaning))/100) %>% 
      dplyr::mutate(owners=as.numeric(gsub("\\.","",owners)))
    
    Sys.sleep(floor(runif(n = 1,min = 20,max = 30)))
  
  
}))

df_nordnet_etf_pareto = df_nordnet_etf %>% 
  dplyr::mutate(name=gsub("Germany","",name)) %>% 
  filter(!is.na(gain_1yr)) %>% 
  filter(!is.na(aaop)) %>% 
  psel(df = . , pref = high(gain_1yr) * low(aaop) , top = nrow(.)) %>% 
  filter(.level<5) %>% 
  dplyr::mutate(.level=factor(.level))

df_nordnet_etf_pareto %>% 
  ggplot(.,aes(x=aaop,y=gain_1yr,color=.level)) +
  geom_point() +
  geom_line() +
  scale_x_continuous(labels = scales::percent) +
  scale_y_continuous(labels = scales::percent) +
  facet_wrap(~.level) +
  geom_text(aes(label=name),size=2)



df_nordnet_etf_pareto %>% 
  ggplot(.,aes(x=.level,y=gain_1yr,size=aaop,color=.level)) +
  geom_point() +
  scale_y_continuous(labels = scales::percent) +
  geom_text(aes(label=name),size=2,vjust=-2)
```

